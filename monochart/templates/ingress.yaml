{{- $root := . -}}
{{- $serviceName := include "common.fullname" . -}}
{{- range $name, $ingress := .Values.ingress -}}
{{- if $ingress.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
{{- with $ingress.annotations }}
  annotations:
{{ toYaml . | indent 4 }}
{{- end }}
{{- if $root.Values.IncludeForecastleEnv.enabled }}
    # Forecastle gives you access to a control panel where you can see your running applications and access them on Kubernetes.
    # https://github.com/stakater/Forecastle
    # Show the app on the forecastle panel
    forecastle.stakater.com/expose: "true"
    # Name of the group to put this app.. Use if you want to show in different group  than the namespace.
    forecastle.stakater.com/group: {{ $root.Values.IncludeForecastleEnv.group }}
    # A comma separated list of name of the forecastle instance. Use when you have multiple forecastle dashboards
    forecastle.stakater.com/instance: {{ $root.Values.IncludeForecastleEnv.instance }}
    # Use a different name, if empty will use the default app name.
    # forecastle.stakater.com/appName: "emaster-pos-dev-00"
{{- end }}
  {{- /* 
  Annotations below are necessary for Application Load Balancer to allow access to only ZScaler users and expose only
  some of the choosen URL paths (endpoints).

  Skip making them if that's internal ALB. Other way check if ingress class is as expected:
  
  if className key is present check if value indicate the ALB usage
  or 
  if "kubernetes.io/ingress.class" annotation is present check it's set to use ALB 

  */}}
  {{- if and (
      or 
        (and ( hasKey $ingress "className" ) (eq $ingress.className "alb")) 
        (eq (index $ingress.annotations "kubernetes.io/ingress.class") "alb") 
      )
      (ne (index $ingress.annotations "alb.ingress.kubernetes.io/scheme") "internal")
  }}
    # Expose paths to public access (without ZScaler)
    # Note the name (actions.<name>) can't be longer than 63 characters
    alb.ingress.kubernetes.io/actions.{{ $serviceName }}-public: '{
      "type":"forward",
      "forwardConfig":{
        "targetGroups":[{
          "serviceName":"{{ $serviceName }}",
          "servicePort":{{- if default "<none>" $ingress.port | regexMatch "^[0-9]*$" }} {{ $ingress.port | quote }}
                        {{- else }} {{ hasKey $ingress "port" | ternary $ingress.port "default" | quote }} 
                        {{- end }},
          "weight":100}
        ]}
    }'
    # Block entire traffic except ZScaler users
      # ZScaler Private Access IPs:
      # - 34.238.231.165
      # - 34.202.59.188
      # - 34.197.162.237
    alb.ingress.kubernetes.io/conditions.{{ $serviceName }}: '[{
      "field":"source-ip",
      "sourceIpConfig": {
        "values":[
          "34.238.231.165/32",
          "34.202.59.188/32",
          "34.197.162.237/32"
        ]
      }
    }]'
  {{- end }}
  labels:
{{- with $ingress.labels }}
{{ toYaml . | indent 4 }}
{{- end }}
{{ include "common.labels.standard" $root | indent 4 }}
    ingressName: {{ $name }}
  name: {{ include "common.fullname" $root }}-{{ $name }}
spec:
{{- if and ( hasKey $ingress "className" )}}
  ingressClassName: {{ $ingress.className }}
{{- end }}
  rules:
{{- range $host, $paths := $ingress.hosts }}
    - host: {{ $host | quote }}
      http:
        paths:
          {{/* 
            Create public URL paths (endpoints) for Application Load Balancer. The condition will verify that the
            ingress class name is as expected.
          */}}
          {{- if or 
            (and ( hasKey $ingress "className" ) (eq $ingress.className "alb")) 
            (eq (index $ingress.annotations "kubernetes.io/ingress.class") "alb") 
          }}
            {{- if ne (index $ingress.annotations "alb.ingress.kubernetes.io/scheme") "internal" }}
          # ALB support (EKS)
              {{- range $paths }}
          - path: {{ . }}
            pathType: Exact
            backend:
              service:
                name: {{ $serviceName }}-public
                port:
                  name: use-annotation
              {{- end }}
          # Part of annotation rule for block entire traffic except for ZScaler users
            {{- end }}
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ $serviceName }}
                port:
                  {{- if default "<none>" $ingress.port | regexMatch "^[0-9]*$" }}
                  number: {{ $ingress.port }}
                  {{- else }}
                  name: {{ hasKey $ingress "port" | ternary $ingress.port "default" }}
                  {{- end }}
          {{- else }}
          # A pattern we use with NLB (KOPS mostly)
          - path: {{ $paths }}
            pathType: Prefix
            backend:
              service:
                name: {{ $serviceName }}
                port:
                  {{- if default "<none>" $ingress.port | regexMatch "^[0-9]*$" }}
                  number: {{ $ingress.port }}
                  {{- else }}
                  name: {{ hasKey $ingress "port" | ternary $ingress.port "default" }}
                  {{- end }}
          {{- end }}
{{- end -}}
{{- with $ingress.tls }}
  tls:
{{ toYaml . | indent 4 }}
{{- end -}}
{{- end -}}

{{- end -}}
