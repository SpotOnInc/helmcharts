{{- $root := . -}}
{{- $serviceName := include "common.fullname" . -}}
{{- range $name, $ingress := .Values.ingress -}}
{{- if $ingress.enabled }}

  {{- if and 
    (ne (index $ingress.annotations "alb.ingress.kubernetes.io/scheme") "internal") (
      or 
        (and ( hasKey $ingress "className" ) (eq $ingress.className "alb")) 
        (eq (index $ingress.annotations "kubernetes.io/ingress.class") "alb") 
      )
  }}
    # Expose paths to public access (without ZScaler)
    # Note the name (actions.<name>) can't be longer than 63 characters
    alb.ingress.kubernetes.io/actions.{{ $serviceName }}-public: '{
      "type":"forward",
      "forwardConfig":{
        "targetGroups":[{
          "serviceName":"{{ $serviceName }}",
          "servicePort":{{- if default "<none>" $ingress.port | regexMatch "^[0-9]*$" }} {{ $ingress.port | quote }}
                        {{- else }} {{ hasKey $ingress "port" | ternary $ingress.port "default" | quote }} 
                        {{- end }},
          "weight":100}
        ]}
    }'
    # Block entire traffic except ZScaler users
      # ZScaler Private Access IPs:
      # - 34.238.231.165
      # - 34.202.59.188
      # - 34.197.162.237
    alb.ingress.kubernetes.io/conditions.{{ $serviceName }}: '[{
      "field":"source-ip",
      "sourceIpConfig": {
        "values":[
          "34.238.231.165/32",
          "34.202.59.188/32",
          "34.197.162.237/32"
        ]
      }
    }]'
  {{- end }}
{{- end -}}

{{- end -}}
